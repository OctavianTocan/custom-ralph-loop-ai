name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Get previous tag
        id: previous_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found"
          else
            echo "Previous tag: $PREV_TAG"
          fi
      
      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH
      
      - name: Generate AI release notes
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          if [ -z "${{ steps.previous_tag.outputs.previous_tag }}" ]; then
            COMMITS=$(git log --pretty=format:"- %s" HEAD~10..HEAD)
            STATS=$(git diff --stat HEAD~10..HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s" ${{ steps.previous_tag.outputs.previous_tag }}..HEAD)
            STATS=$(git diff --stat ${{ steps.previous_tag.outputs.previous_tag }}..HEAD)
          fi
          
          # Create prompt for Cursor AI
          cat > prompt.txt << EOF
          You are generating release notes for version ${{ steps.version.outputs.version }} of Ralph - an autonomous AI coding loop system.
          
          Previous version: ${{ steps.previous_tag.outputs.previous_tag || 'None (first release)' }}
          
          COMMIT MESSAGES:
          $COMMITS
          
          FILE STATISTICS:
          $STATS
          
          Generate concise, user-focused release notes in markdown format with:
          
          1. A brief summary paragraph (2-3 sentences) explaining what this release brings
          2. Key changes organized by category (use emojis):
             - âœ¨ Features (new capabilities)
             - ðŸ› Fixes (bug fixes)
             - ðŸ“š Documentation (doc improvements)
             - ðŸ”§ Improvements (enhancements, refactors)
             - âš ï¸  Breaking Changes (if any)
          
          3. Keep it concise - users want to quickly understand what changed
          4. Focus on user impact, not implementation details
          5. Use bullet points within each category
          
          DO NOT include a title or version number (it will be added separately).
          DO NOT include generic fluff like "We're excited to announce..."
          EOF
          
          # Generate release notes with Cursor CLI
          cursor-agent -p --output-format text "$(cat prompt.txt)" > release_notes_final.md || {
            # Fallback to basic format if Cursor fails
            echo "## Changes" > release_notes_final.md
            echo "" >> release_notes_final.md
            echo "$COMMITS" >> release_notes_final.md
            echo "" >> release_notes_final.md
            echo "## Statistics" >> release_notes_final.md
            echo "" >> release_notes_final.md
            echo '```' >> release_notes_final.md
          echo "$STATS" >> release_notes_final.md
          echo '```' >> release_notes_final.md
        }
      
      - name: Update CHANGELOG.md
        run: |
          RELEASE_DATE=$(date +%Y-%m-%d)
          VERSION=${{ steps.version.outputs.version }}
          
          # Create CHANGELOG.md if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            # Use quoted 'EOF' to prevent variable expansion in static header content
            cat > CHANGELOG.md << 'EOF'
          # Changelog
          
          All notable changes to this project will be documented in this file.
          
          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
          
          ## [Unreleased]
          EOF
          fi
          
          # Create temporary file with new release entry
          # Use unquoted EOF to allow variable expansion for VERSION and RELEASE_DATE
          cat > new_entry.md << EOF
          
          ## [$VERSION] - $RELEASE_DATE
          
          EOF
          
          # Append the AI-generated release notes, ensuring the file exists and is non-empty
          if [ -s release_notes_final.md ]; then
            cat release_notes_final.md >> new_entry.md
          else
            echo "Error: release_notes_final.md is missing or empty. Aborting changelog update." >&2
            exit 1
          fi
          
          # Insert the new entry after the [Unreleased] section
          # Find the line number of [Unreleased] and insert after it
          if grep -q "## \[Unreleased\]" CHANGELOG.md; then
            # Split the file at [Unreleased] section and insert new content
            awk '/## \[Unreleased\]/{print; print ""; while ((getline line < "new_entry.md") > 0) print line; close("new_entry.md"); next}1' CHANGELOG.md > CHANGELOG.tmp
            mv CHANGELOG.tmp CHANGELOG.md
          else
            # If no [Unreleased] section, just append to the file
            cat new_entry.md >> CHANGELOG.md
          fi
          
          # Clean up temporary file
          rm -f new_entry.md
          
          echo "CHANGELOG.md updated with release $VERSION"
      
      - name: Check changelog changes (no commit on tag)
        run: |
          # This workflow is triggered by a pushed tag, so the tagged commit already exists.
          # To avoid diverging branch history from the tag, we do NOT commit or push changes here.
          # The changelog update is generated for informational purposes and will be included
          # in future releases when the changelog update happens before tag creation.
          if git diff --quiet -- CHANGELOG.md; then
            echo "No changes to CHANGELOG.md in the workspace."
          else
            echo "CHANGELOG.md was updated in the workspace for this release."
            echo "To include changelog updates in tagged releases, update the CHANGELOG.md"
            echo "before creating and pushing the version tag."
          fi
      
      - name: Create release packages
        run: |
          # Create tarball
          tar -czf ralph-v${{ steps.version.outputs.version }}.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.ralph/sessions' \
            --exclude='node_modules' \
            --exclude='*.log' \
            --exclude='*.tar.gz' \
            --exclude='*.zip' \
            .
          
          # Create zip
          zip -qr ralph-v${{ steps.version.outputs.version }}.zip . \
            -x '*.git*' \
            -x '*/.ralph/sessions/*' \
            -x '*/node_modules/*' \
            -x '*.log' \
            -x '*.tar.gz' \
            -x '*.zip'
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ralph ${{ steps.version.outputs.tag }}
          body_path: release_notes_final.md
          files: |
            ralph-v${{ steps.version.outputs.version }}.tar.gz
            ralph-v${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
